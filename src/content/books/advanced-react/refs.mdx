---
title: "Refsï¼šä»å­˜å‚¨æ•°æ®åˆ°å‘½ä»¤å¼ API"
description: "React çš„è®¸å¤šç¾å¥½ä¹‹å¤„åœ¨äºå®ƒæŠ½è±¡äº†å¤„ç†çœŸå® DOM çš„å¤æ‚æ€§ã€‚æˆ‘ä»¬æ— éœ€æ‰‹åŠ¨æŸ¥è¯¢å…ƒç´ ã€ä¸ºå¦‚ä½•æ·»åŠ ç±»è€Œè‹¦æ¼ï¼Œæˆ–ä¸æµè§ˆå™¨çš„ä¸ä¸€è‡´æ€§æ–—äº‰ï¼Œè€Œæ˜¯å¯ä»¥ä¸“æ³¨äºç¼–å†™ç»„ä»¶å’Œç”¨æˆ·ä½“éªŒã€‚ä¸è¿‡ï¼Œä»ç„¶æœ‰ä¸€äº›æƒ…å†µï¼ˆè™½ç„¶å¾ˆå°‘ï¼‰éœ€è¦è®¿é—®å®é™…çš„ DOMã€‚"

name: "refs"
---

ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ Refsã€‚æ²¡æœ‰ç¥ç§˜æ„Ÿï¼Œè¿™æ¬¡æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå¸¦æœ‰ç®€å•éªŒè¯çš„åä¸½è¡¨å•ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ ï¼š

- ä¸ºä½•æˆ‘ä»¬ä»ç„¶éœ€è¦è®¿é—® DOM å…ƒç´ ã€‚
- ä»€ä¹ˆæ˜¯ Refï¼ŒRefs å’ŒçŠ¶æ€ä¹‹é—´çš„åŒºåˆ«ã€‚
- å¦‚ä½•ä½¿ç”¨ Refs è®¿é—® UI å…ƒç´ ã€‚
- ä»€ä¹ˆæ˜¯ forwardRefï¼Œå¦‚ä½•ä½¿ç”¨å®ƒï¼Œä»¥åŠå¦‚ä½•é¿å…ä½¿ç”¨å®ƒï¼ˆä½ ä¼šæ˜ç™½ä¸ºä»€ä¹ˆï¼ï¼‰
- ä¸ºä½•æˆ‘ä»¬åœ¨ React ä¸­ä»éœ€è¦å‘½ä»¤å¼ APIï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨æˆ–ä¸ä½¿ç”¨ useImperativeHandle æ¥å®ç°å®ƒã€‚

---

### åœ¨ React ä¸­è®¿é—® DOM

å‡è®¾æˆ‘æƒ³ä¸ºæˆ‘æ­£åœ¨ç»„ç»‡çš„ä¼šè®®å®ç°ä¸€ä¸ªæ³¨å†Œè¡¨å•ã€‚æˆ‘å¸Œæœ›äººä»¬åœ¨æˆ‘å‘é€è¯¦ç»†ä¿¡æ¯ä¹‹å‰æä¾›ä»–ä»¬çš„å§“åã€ç”µå­é‚®ä»¶å’Œ Twitter è´¦å·ã€‚â€œå§“åâ€å’Œâ€œç”µå­é‚®ä»¶â€å­—æ®µæˆ‘æƒ³è®¾ä¸ºå¿…å¡«ã€‚ä½†æˆ‘ä¸æƒ³åœ¨ç”¨æˆ·å°è¯•æäº¤ç©ºå­—æ®µæ—¶æ˜¾ç¤ºæ¼äººçš„çº¢è‰²è¾¹æ¡†ã€‚æˆ‘æƒ³è®©è¡¨å•çœ‹èµ·æ¥é…·ä¸€ç‚¹ã€‚å› æ­¤ï¼Œæˆ‘å¸Œæœ›èšç„¦äºç©ºå­—æ®µå¹¶ç¨å¾®æ™ƒåŠ¨ä¸€ä¸‹ï¼Œä»¥å¼•èµ·æ³¨æ„ï¼Œä»…ä»…æ˜¯ä¸ºäº†å¥½ç©ã€‚

ç°åœ¨ï¼ŒReact æä¾›äº†å¾ˆå¤šåŠŸèƒ½ï¼Œä½†å¹¶æ²¡æœ‰æä¾›ä¸€åˆ‡ã€‚åƒâ€œæ‰‹åŠ¨èšç„¦ä¸€ä¸ªå…ƒç´ â€æˆ–â€œæ™ƒåŠ¨é‚£ä¸ªå…ƒç´ â€è¿™æ ·çš„åŠŸèƒ½å¹¶ä¸æ˜¯å…¶åŒ…çš„ä¸€éƒ¨åˆ†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æŒæ¡ä¸€äº›ç”Ÿç–çš„åŸç”Ÿ JavaScript API æŠ€èƒ½ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¿é—®å®é™…çš„ DOM å…ƒç´ ã€‚

åœ¨é React çš„ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬ä¼šåšç±»ä¼¼è¿™æ ·çš„äº‹æƒ…ï¼š

```jsx
const element = document.getElementById("bla");
```

åœ¨é‚£ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥èšç„¦å®ƒï¼š

```jsx
element.focus();
```

æˆ–è€…æ»šåŠ¨åˆ°å®ƒï¼š

```jsx
element.scrollIntoView();
```

æˆ–è€…ä»»ä½•æˆ‘ä»¬æ‰€æƒ³è¦çš„äº‹æƒ…ã€‚åœ¨ React ä¸–ç•Œä¸­ä½¿ç”¨åŸç”Ÿ DOM API çš„ä¸€äº›å…¸å‹ç”¨ä¾‹åŒ…æ‹¬ï¼š

- æ‰‹åŠ¨èšç„¦å…ƒç´ ï¼Œå¦‚è¡¨å•ä¸­çš„è¾“å…¥å­—æ®µã€‚
- å½“æ˜¾ç¤ºå¼¹å‡ºå…ƒç´ æ—¶ï¼Œæ£€æµ‹ç»„ä»¶å¤–éƒ¨çš„ç‚¹å‡»ã€‚
- åœ¨å…ƒç´ å‡ºç°åœ¨å±å¹•ä¸Šåæ‰‹åŠ¨æ»šåŠ¨åˆ°å®ƒã€‚
- è®¡ç®—å±å¹•ä¸Šç»„ä»¶çš„å¤§å°å’Œè¾¹ç•Œï¼Œä»¥æ­£ç¡®å®šä½åƒå·¥å…·æç¤ºè¿™æ ·çš„ä¸œè¥¿ã€‚

å°½ç®¡ä»æŠ€æœ¯ä¸Šè®²ï¼Œç°åœ¨æ²¡æœ‰ä»€ä¹ˆé˜»æ­¢æˆ‘ä»¬ä½¿ç”¨ getElementByIdï¼Œä½† React ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§ç¨å¾®æ›´å¼ºå¤§çš„æ–¹å¼æ¥è®¿é—®è¯¥å…ƒç´ ï¼Œè€Œä¸éœ€è¦åˆ°å¤„æ‰©å±• id æˆ–äº†è§£åº•å±‚ DOM ç»“æ„ï¼šRefsã€‚

---

### ä»€ä¹ˆæ˜¯ Refï¼Ÿ

Ref æ˜¯ä¸€ä¸ªå¯å˜å¯¹è±¡ï¼ŒReact åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´ä¿æŒå®ƒçš„å­˜åœ¨ã€‚è®°ä½ï¼Œç»„ä»¶å†…å£°æ˜çš„æ‰€æœ‰å†…å®¹éƒ½ä¼šä¸æ–­è¢«é‡æ–°åˆ›å»ºï¼Ÿ

```jsx
const Component = () => {
  // â€œdataâ€ å¯¹è±¡åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶éƒ½æ˜¯æ–°çš„
  const data = { id: "test" };
};
```

ç»„ä»¶åªæ˜¯å‡½æ•°ï¼Œæ‰€ä»¥å…¶ä¸­çš„ä¸€åˆ‡åŸºæœ¬ä¸Šæ˜¯è¯¥å‡½æ•°çš„å±€éƒ¨å˜é‡ã€‚Refs å…è®¸æˆ‘ä»¬ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚
è¦åˆ›å»ºä¸€ä¸ª Refï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ useRef é’©å­ï¼Œå¹¶ä¼ é€’ Ref çš„åˆå§‹å€¼ï¼š

```jsx
const Component = () => {
  const ref = useRef({ id: "test" });
};
```

è¯¥åˆå§‹å€¼ç°åœ¨å¯ä»¥é€šè¿‡ ref.current å±æ€§è®¿é—®ï¼šæˆ‘ä»¬ä¼ é€’ç»™ Ref çš„æ‰€æœ‰å†…å®¹éƒ½å­˜å‚¨åœ¨è¿™é‡Œã€‚

```jsx
const Component = () => {
  // åœ¨æ­¤å¤„ä¼ é€’åˆå§‹å€¼
  const ref = useRef({ id: "test" });
  useEffect(() => {
    // åœ¨æ­¤å¤„è®¿é—®
    console.log(ref.current);
  });
};
```

åˆå§‹å€¼æ˜¯ç¼“å­˜çš„ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´æ¯”è¾ƒ ref.currentï¼Œå¼•ç”¨å°†ä¿æŒç›¸åŒã€‚è¿™å°±åƒæˆ‘ä»¬åœ¨è¯¥å¯¹è±¡ä¸Šä½¿ç”¨ useMemo é’©å­ä¸€æ ·ã€‚

ä¸€æ—¦åˆ›å»ºäº† Refï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ useEffect æˆ–äº‹ä»¶å¤„ç†å™¨ä¸­å¯¹å…¶èµ‹å€¼ã€‚å®ƒåªæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼š

```jsx
const Component = () => {
  useEffect(() => {
    // å°† URL æŒ‡å®šä¸º IDï¼Œå½“ URL å‘ç”Ÿæ›´æ”¹æ—¶
    ref.current = { id: url };
  }, [url]);
};
```

è¿™ä¸€åˆ‡çœ‹èµ·æ¥å’ŒçŠ¶æ€éå¸¸ç›¸ä¼¼ï¼Œä¸æ˜¯å—ï¼Ÿåªæ˜¯ API ä¸åŒã€‚é‚£ä¹ˆé—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ä¸ºä»€ä¹ˆåˆ°å¤„ä½¿ç”¨çŠ¶æ€ï¼Œè€Œ Ref è¢«è§†ä¸ºä¸åº”ä½¿ç”¨çš„é€ƒç”Ÿèˆ±å‘¢ï¼Ÿåœ¨è®©æˆ‘ä»¬çš„è¡¨å•å˜å¾—æ›´åŠ åä¸½ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¼„æ¸…æ¥šè¿™ä¸ªé—®é¢˜ã€‚ä¹Ÿè®¸æˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦çŠ¶æ€ï¼Ÿ

---

### Ref å’ŒçŠ¶æ€çš„åŒºåˆ«

è®©æˆ‘ä»¬å¼€å§‹å®ç°è¡¨å•ï¼Œå¹¶å®ç°ç¬¬ä¸€ä¸ªè¾“å…¥å­—æ®µå’Œæäº¤æŒ‰é’®ã€‚

```jsx
const Form = () => {
  return (
    <>
      <input type="text" />
      <button onClick={submit}>submit</button>
    </>
  );
};
```

ç°åœ¨ï¼Œä¸ºäº†è®©æˆ‘ä»¬çš„æäº¤å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼æå–è¾“å…¥å­—æ®µçš„å†…å®¹ã€‚åœ¨ React ä¸­ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä¸ºè¾“å…¥æ·»åŠ  onChange å›è°ƒï¼Œå°†è¯¥ä¿¡æ¯ä¿å­˜åœ¨çŠ¶æ€ä¸­ï¼Œä»¥ä¾¿åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´ä¿æŒä¸€è‡´ï¼Œç„¶ååœ¨æäº¤å‡½æ•°ä¸­è®¿é—®å®ƒï¼š

```jsx
const Form = () => {
  const [value, setValue] = useState();
  const onChange = (e) => {
    setValue(e.target.value);
  };
  const submit = () => {
    // åœ¨æ­¤å¤„å‘é€åˆ°åç«¯
    console.log(value);
  };
  return (
    <>
      <input type="text" onChange={onChange} />
      <button onClick={submit}>submit</button>
    </>
  );
};
```

ä½†æˆ‘å·²ç»å¤šæ¬¡æåˆ°ï¼Œæˆ‘ä»¬å­˜å‚¨åœ¨ Ref ä¸­çš„ä»»ä½•å†…å®¹ä¹Ÿä¼šåœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´ä¿æŒä¸€è‡´ã€‚è€Œä¸”ï¼Œæ–¹ä¾¿çš„æ˜¯ï¼Œä»»ä½•å†…å®¹éƒ½å¯ä»¥åˆ†é…ç»™ Refã€‚å¦‚æœæˆ‘ä»…ä»…å°†è¾“å…¥ä¸­çš„å€¼ä¿å­˜åˆ° Ref ä¸­è€Œä¸æ˜¯çŠ¶æ€ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```jsx
const Form = () => {
  const ref = useRef();
  const onChange = (e) => {
    // å°†å…¶ä¿å­˜åˆ° ref è€Œä¸æ˜¯ state
    ref.current = e.target.value;
  };
  const submit = () => {
    // ä» ref è€Œä¸æ˜¯ state è·å–å®ƒ
    console.log(ref.current);
  };
  return (
    <>
      <input type="text" onChange={onChange} />
      <button onClick={submit}>submit</button>
    </>
  );
};
```

å®ƒä¼¼ä¹ä¸çŠ¶æ€çš„æ•ˆæœå®Œå…¨ç›¸åŒï¼šæˆ‘åœ¨è¾“å…¥å­—æ®µä¸­è¾“å…¥å†…å®¹ï¼Œç„¶åæŒ‰ä¸‹æŒ‰é’®ï¼Œå€¼è¢«å‘é€ã€‚

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/01)
</Callout>

é‚£ä¹ˆï¼ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬é€šå¸¸ä¸ºä½•åœ¨åº”ç”¨ä¸­çœ‹ä¸åˆ°è¿™ç§æ¨¡å¼ï¼Ÿæœ‰å‡ ä¸ªåŸå› ã€‚

---

### Ref æ›´æ–°ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“

Refs å’ŒçŠ¶æ€ä¹‹é—´æœ€å¤§çš„ã€æœ€æ˜æ˜¾çš„åŒºåˆ«ä¹‹ä¸€æ˜¯ï¼ŒRefs çš„æ›´æ–°ä¸ä¼šå¯¼è‡´é‡æ–°æ¸²æŸ“ã€‚å¦‚æœä½ åœ¨è¿™ä¸¤ç§å½¢å¼ä¸­éƒ½æ”¾ç½® console.logï¼Œä½ ä¼šçœ‹åˆ°ä½¿ç”¨çŠ¶æ€çš„ Form ç»„ä»¶åœ¨æ¯æ¬¡é”®å…¥æ—¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œè€Œä½¿ç”¨ Ref çš„ Form åˆ™ä¿æŒå®‰é™ã€‚

```jsx
useEffect(() => {
  console.log("Form component re-renders");
});
```

ä»è¡¨é¢ä¸Šçœ‹ï¼Œè¿™ä¼¼ä¹æ˜¯ä¸ªå¥½æ¶ˆæ¯ã€‚éš¾é“è¿™æœ¬ä¹¦çš„åŠæ•°ç¯‡å¹…ä¸æ˜¯ä¸“é—¨è®¨è®ºé‡æ–°æ¸²æŸ“ä»¥åŠå¦‚ä½•é€ƒé¿å®ƒå—ï¼Ÿå¦‚æœ Refs ä¸ä¼šå¯¼è‡´é‡æ–°æ¸²æŸ“ï¼Œé‚£å®ƒä»¬å½“ç„¶æ˜¯æ‰€æœ‰æ€§èƒ½é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Ÿ

ç»å¯¹ä¸æ˜¯ã€‚å¦‚æœä½ è®°å¾—ç¬¬ä¸€ç« ï¼Œé‡æ–°æ¸²æŸ“æ˜¯ React ç”Ÿå‘½å‘¨æœŸçš„å…³é”®éƒ¨åˆ†ã€‚è¿™æ˜¯ React å¦‚ä½•ç”¨æ–°ä¿¡æ¯æ›´æ–°æˆ‘ä»¬çš„ç»„ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘æƒ³åœ¨æ–‡æœ¬å­—æ®µä¸‹æ–¹æ˜¾ç¤ºè¾“å…¥çš„å­—æ¯æ•°é‡ï¼Œæˆ‘å°±æ— æ³•ç”¨ Refs æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

```jsx
const Form = () => {
  const ref = useRef();
  const numberOfLetters = ref.current?.length ?? 0;
  return (
    <>
      <input type="text" onChange={onChange} />
      {/* ä¸å·¥ä½œ */}
      Characters count: {numberOfLetters}
      <button onClick={submit}>submit</button>
    </>
  );
};
```

Refs çš„æ›´æ–°ä¸ä¼šå¯¼è‡´é‡æ–°æ¸²æŸ“ï¼Œå› æ­¤æˆ‘ä»¬çš„è¿”å›è¾“å‡ºå°†å§‹ç»ˆæ˜¾ç¤º 0 çš„`numberOfLetters`ã€‚

å®é™…ä¸Šï¼Œæ¯” 0 æ›´æœ‰è¶£çš„æ˜¯ã€‚å¦‚æœä¸è¯¥è¾“å…¥å®Œå…¨æ— å…³çš„äº‹æƒ…å¯¼è‡´ Form ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œå€¼å°†çªç„¶æ›´æ–°ä¸ºæœ€æ–°å€¼ã€‚Ref åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´å­˜å‚¨è¯¥å€¼ï¼Œè®°å¾—å—ï¼Ÿå¦‚æœæˆ‘åœ¨è¯¥è¡¨å•ä¸­æ·»åŠ ä¸€ä¸ªç®€å•çš„æ¨¡æ€å¯¹è¯æ¡†ï¼Œé‚£ä¹ˆæ‰“å¼€å¯¹è¯æ¡†å°†è§¦å‘ç»„ä»¶æ›´æ–°è‡ªèº«ï¼Œå¹¶ä½¿å­—æ¯æ•°é‡å‘ç”Ÿå˜åŒ–ã€‚

```jsx
const Form = () => {
  // å¯¹è¯æ¡†çš„çŠ¶æ€
  const [isOpen, setIsOpen] = useState(false);
  const ref = useRef();
  const numberOfLetters = ref.current?.length ?? 0;
  return (
    <>
      <input type="text" onChange={onChange} />
      {/* å½“æ‚¨åœ¨å­—æ®µä¸­é”®å…¥æ—¶ï¼Œè¿™ä¸ä¼šæ”¹å˜ */}
      {/* ä»…åœ¨æ‰“å¼€/å…³é—­å¯¹è¯æ¡†æ—¶ */}
      Characters count: {numberOfLetters}
      <button onClick={submit}>submit</button>
      {/* åœ¨æ­¤å¤„æ·»åŠ å¯¹è¯æ¡† */}
      <button onClick={() => setIsOpen(true)}>Open dialog</button>
      {isOpen ? <ModalDialog onClose={() => setIsOpen(false)} /> : null}
    </>
  );
};
```

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/02)
</Callout>

æ›´æœ‰è¶£çš„æ˜¯ã€‚å¦‚æœå°†è¯¥å€¼ä½œä¸ºåŸå§‹å€¼ä¼ é€’ç»™ä¸‹æ¸¸ç»„ä»¶ï¼Œå®ƒçš„å˜åŒ–å°†ä¸ä¼šè¢«æ•æ‰ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘æƒ³å®ç°æŸç§â€œæœç´¢ç»“æœâ€ç»„ä»¶ã€‚å®ƒå°†æ¥å—è¯¥æ–‡æœ¬å€¼ä½œä¸º propï¼Œå¹¶åœ¨ç”¨æˆ·æŒ‰ä¸‹â€œæ˜¾ç¤ºç»“æœâ€æŒ‰é’®æ—¶æ˜¾ç¤ºå¼‚æ­¥æœç´¢ç»“æœï¼š

```jsx
const SearchResults = ({ search }) => {
  const [showResults, setShowResults] = useState(false);
  return (
    <>
      Searching for: {search} <br />
      {/*è¿™å°†è§¦å‘é‡æ–°æ¸²æŸ“*/}
      <button onClick={() => setShowResults(!showResults)}>show results</button>
    </>
  );
};
```

å¦‚æœæˆ‘åœ¨æˆ‘ä»¬çš„ Form ä¸­ä½¿ç”¨è¯¥ç»„ä»¶ï¼Œå¹¶ä¸”æˆ‘ä»¬å°†å€¼ä¿å­˜åœ¨ Ref ä¸­ï¼Œå®ƒæ ¹æœ¬æ— æ³•å·¥ä½œã€‚

```jsx
const Form = () => {
  const ref = useRef();
  const onChange = (e) => {
    ref.current = e.target.value;
  };
  return (
    <>
      <input type="text" onChange={onChange} />
      {/* å°†æ°¸è¿œä¸ä¼šæ›´æ–° */}
      <SearchResults search={ref.current} />
    </>
  );
};
```

Ref æ›´æ–°æ°¸è¿œä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼Œå› æ­¤ SearchResults ç»„ä»¶ä¸Šçš„æœç´¢ prop ä»æœªæ˜¾å¼æ›´æ–°ã€‚å³ä½¿æˆ‘ä»¬é€šè¿‡å•å‡»â€œæ˜¾ç¤ºç»“æœâ€æŒ‰é’®åœ¨ SearchResults å†…éƒ¨è§¦å‘é‡æ–°æ¸²æŸ“ï¼Œæœç´¢å€¼ä»ç„¶æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/03)
</Callout>

---

### Ref æ›´æ–°æ˜¯åŒæ­¥å’Œå¯å˜çš„

ç¬¬äºŒä¸ªå¤§åŒºåˆ«æ˜¯ï¼ŒRef æ›´æ–°æ˜¯åŒæ­¥çš„ã€‚æˆ‘ä»¬æ¯•ç«Ÿåªæ˜¯ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™åœ¨ JavaScript ä¸­æ˜¯ä¸€ä¸ªåŒæ­¥æ“ä½œã€‚ç„¶è€Œï¼ŒçŠ¶æ€é€šå¸¸æ˜¯å¼‚æ­¥çš„ã€‚å®ƒç”šè‡³ä¸ä»…ä»…æ˜¯å¼‚æ­¥çš„ï¼šçŠ¶æ€æ›´æ–°åœ¨â€œå¿«ç…§â€ä¸­è¿è¡Œã€‚React æœ‰ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿæ¥ç®¡ç†å®ƒï¼Œå¹¶ç¡®ä¿åœ¨ä¸€ä¸ªâ€œå¿«ç…§â€å†…çš„æ•°æ®å’Œç»„ä»¶æ˜¯ä¸€è‡´çš„å¹¶æ­£ç¡®æ›´æ–°ã€‚

ç„¶è€Œï¼ŒRef åˆ™æ²¡æœ‰è¿™äº›ï¼šæˆ‘ä»¬ç›´æ¥ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡ï¼Œä»…æ­¤è€Œå·²ã€‚

å½“ä½ å°è¯•åœ¨ onChange å›è°ƒä¸­è®¿é—®çŠ¶æ€å’Œå€¼æ—¶ï¼Œè¿™ä¸€ç‚¹å°†å˜å¾—éå¸¸æ˜æ˜¾ã€‚

```jsx
const Form = () => {
  const [value, setValue] = useState();
  const onChange = (e) => {
    console.log("before", value);
    setValue(e.target.value);
    console.log("after", value); // åŒä¸Š
  };
};
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œâ€œä¹‹å‰â€å’Œâ€œä¹‹åâ€çš„å€¼å°†æ˜¯ç›¸åŒçš„ã€‚å½“æˆ‘ä»¬è°ƒç”¨ setValue æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯ç«‹å³æ›´æ–°çŠ¶æ€ã€‚æˆ‘ä»¬åªæ˜¯åœ¨è®© React çŸ¥é“å®ƒéœ€è¦åœ¨å®Œæˆå½“å‰æ“ä½œåå®‰æ’ä¸€æ¬¡çŠ¶æ€æ›´æ–°ã€‚

å¯¹äº Refï¼Œæƒ…å†µæ­£å¥½ç›¸åï¼š

```jsx
const Form = () => {
  const ref = useRef();
  const onChange = (e) => {
    console.log("before", ref.current);
    ref.current = e.target.value;
    console.log("after", ref.current); // å·²æ›´æ”¹
  };
};
```

æˆ‘ä»¬ä¿®æ”¹äº†ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸­çš„æ•°æ®ç«‹å³å¯ç”¨ï¼Œä½†æ²¡æœ‰ä»»ä½•æ¥è‡ª React ç”Ÿå‘½å‘¨æœŸçš„è§¦å‘ã€‚

---

### é‚£ä¹ˆä½•æ—¶å¯ä»¥ä½¿ç”¨ Refï¼Ÿ

è€ƒè™‘åˆ°è¿™äº›åŒºåˆ«ï¼Œå®é™…ä¸Šåœ¨ä½•æ—¶ä½¿ç”¨ Ref å­˜å‚¨æŸäº›ä¸œè¥¿ï¼Œä½•æ—¶æ›´å–œæ¬¢ä½¿ç”¨çŠ¶æ€ï¼Ÿé—®é—®è‡ªå·±è¿™ä¸¤ä¸ªé—®é¢˜ï¼š

- è¯¥å€¼æ˜¯å¦ç”¨äºæ¸²æŸ“ç»„ä»¶ï¼Œç°åœ¨æˆ–å°†æ¥ï¼Ÿ
- è¯¥å€¼æ˜¯å¦ä»¥ä»»ä½•æ–¹å¼ä½œä¸º props ä¼ é€’ç»™å…¶ä»–ç»„ä»¶ï¼Œç°åœ¨æˆ–å°†æ¥ï¼Ÿ

å¦‚æœè¿™ä¸¤ä¸ªé—®é¢˜çš„ç­”æ¡ˆéƒ½æ˜¯â€œæ²¡æœ‰â€ï¼Œé‚£ä¹ˆä½¿ç”¨ Ref æ˜¯å¯ä»¥çš„ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Ref æ¥å­˜å‚¨ä¸€äº›å…³äºç»„ä»¶çš„â€œå¼€å‘â€ä¿¡æ¯ã€‚ä¹Ÿè®¸æˆ‘ä»¬æœ‰å…´è¶£è®¡ç®—ä¸€ä¸ªç»„ä»¶æ¸²æŸ“çš„æ¬¡æ•°ï¼š

```jsx
useEffect(() => {
  ref.current = ref.current + 1;
  console.log("Render number", ref.current);
});
```

æˆ–è€…ï¼Œä¹Ÿè®¸æˆ‘ä»¬æƒ³è®¿é—®å…ˆå‰çš„çŠ¶æ€å€¼ï¼š

```jsx
const usePrevious = (value) => {
  const ref = useRef();
  useEffect(() => {
    // è¿™å°†åœ¨è¿”å›å€¼åæ›´æ”¹
    ref.current = value;
  }, [value]);
  return ref.current;
};
```

ç„¶ååœ¨ `useEffect` ä¸­æœ‰æ¡ä»¶åœ°è§¦å‘æŸäº›æ“ä½œï¼š

```jsx
useEffect(() => {
  if (previuosValue.length > value.length) {
    console.log("Text was deleted");
  } else {
    console.log("Text was added");
  }
}, [previuosValue, value]);
```

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/04)
</Callout>

å½“ç„¶ï¼Œè¿˜å¯ä»¥å°† DOM å…ƒç´ åˆ†é…ç»™ Refã€‚è¿™æ˜¯ Ref æœ€é‡è¦å’Œæœ€å¸¸è§çš„ç”¨ä¾‹ä¹‹ä¸€ã€‚

---

### å°† DOM å…ƒç´ åˆ†é…ç»™ Ref

æˆ‘ä»¬å¯ä»¥ç®€å•åœ°é€šè¿‡ä½¿ç”¨ `useRef` é’©å­åˆ›å»ºä¸€ä¸ª Refï¼Œç„¶åé€šè¿‡ `ref` å±æ€§å°†è¯¥ Ref ä¼ é€’ç»™ä¸€ä¸ª DOM å…ƒç´ æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š

```jsx
const Component = () => {
  const ref = useRef(null);
  // å°† ref é™„åŠ åˆ° input å…ƒç´ 
  return <input ref={ref} />;
};
```

åœ¨è¿™ä¸ªè¾“å…¥ç»„ä»¶æ¸²æŸ“åï¼Œæˆ‘å°†èƒ½å¤Ÿçœ‹åˆ°å®é™…çš„è¾“å…¥ DOM å…ƒç´ ï¼Œæ­£æ˜¯æˆ‘é€šè¿‡ `getElementById` è·å¾—çš„é‚£ä¸ªå…ƒç´ ï¼Œåœ¨ `ref.current` å€¼ä¸­ï¼š

```jsx
const Component = () => {
  const ref = useRef(null);
  useEffect(() => {
    // è¿™å°†æ˜¯å¯¹è¾“å…¥ DOM å…ƒç´ çš„å¼•ç”¨ï¼
    // ä¸æˆ‘ä¸ºå®ƒæ‰§è¡Œ getElementById å®Œå…¨ç›¸åŒ
    console.log(ref.current);
  });
  return <input ref={ref} />;
};
```

è¿™é‡Œéœ€è¦è®°ä½çš„é‡è¦ä¸€ç‚¹æ˜¯ï¼Œref åªä¼šåœ¨å…ƒç´ è¢« React æ¸²æŸ“å¹¶ä¸”å…¶å…³è”çš„ DOM å…ƒç´ è¢«åˆ›å»ºååˆ†é…ã€‚æˆ‘ä»¬éœ€è¦ä¸€äº›ä¸œè¥¿æ¥åˆ†é…ç»™é‚£ä¸ª Refï¼Œä¸æ˜¯å—ï¼Ÿè¿™æ„å‘³ç€ `ref.current` å€¼ä¸ä¼šç«‹å³å¯ç”¨ï¼Œå› æ­¤åƒè¿™æ ·çš„é€»è¾‘å°†ä¸èµ·ä½œç”¨ï¼š

```jsx
const Component = () => {
  const ref = useRef(null);
  // å°è¯•åœ¨å®é™…åˆ†é… ref å€¼ä¹‹å‰è®¿é—® ref å€¼
  // input æ°¸è¿œä¸ä¼šåœ¨æ­¤å¤„å‘ˆç°
  if (!ref.current) return null;
  return <input ref={ref} />;
};
```

æˆ‘ä»¬åº”è¯¥åªåœ¨ `useEffect` é’©å­æˆ–å›è°ƒä¸­è¯»å–å’Œå†™å…¥ `ref.current`ã€‚

æœ€åï¼Œå›åˆ°æˆ‘ä»¬æœ€åˆçš„æƒ³æ³•ï¼Œåˆ›å»ºä¸€ä¸ªåä¸½çš„æ³¨å†Œè¡¨å•ã€‚å¦‚æœæˆ‘å°†å…¶å®ç°ä¸ºä¸€ä¸ªå·¨å¤§çš„ç»„ä»¶ï¼Œæˆ‘å¯ä»¥è¿™æ ·åšï¼š

```jsx
const Form = () => {
  const [name, setName] = useState("");
  const inputRef = useRef(null);
  const onSubmitClick = () => {
    if (!name) {
      // å¦‚æœæœ‰äººå°è¯•æäº¤ç©ºåç§°ï¼Œè¯·èšç„¦è¾“å…¥å­—æ®µ
      ref.current.focus();
    } else {
      //åœ¨æ­¤å¤„æäº¤æ•°æ®ï¼
    }
  };
  return (
    <>
      ...
      <input onChange={(e) => setName(e.target.value)} ref={ref} />
      <button onClick={onSubmitClick}>Submit the form!</button>
    </>
  );
};
```

å°†è¾“å…¥å€¼å­˜å‚¨åœ¨çŠ¶æ€ä¸­ï¼Œä¸ºæ‰€æœ‰è¾“å…¥åˆ›å»º refsï¼Œå½“å•å‡»â€œæäº¤â€æŒ‰é’®æ—¶ï¼Œæˆ‘å°†æ£€æŸ¥è¿™äº›å€¼æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™èšç„¦äºéœ€è¦çš„è¾“å…¥ã€‚

---

### ä½œä¸º prop ä»çˆ¶ç»„ä»¶ä¼ é€’ Ref åˆ°å­ç»„ä»¶

å½“ç„¶ï¼Œåœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä¸ä¼šå°†æ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€ä¸ªå·¨å¤§çš„ç»„ä»¶ä¸­ã€‚æ›´å¯èƒ½çš„æ˜¯ï¼Œæˆ‘å¸Œæœ›å°†è¾“å…¥æå–åˆ°è‡ªå·±çš„ç»„ä»¶ä¸­ï¼šä»¥ä¾¿å¯ä»¥åœ¨å¤šä¸ªè¡¨å•ä¸­é‡ç”¨å®ƒï¼Œå¹¶ä¸”å¯ä»¥å°è£…å’Œæ§åˆ¶å…¶æ ·å¼ï¼Œç”šè‡³å¯èƒ½å…·æœ‰ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œä¾‹å¦‚é¡¶éƒ¨æœ‰æ ‡ç­¾æˆ–å³ä¾§æœ‰å›¾æ ‡ã€‚

```jsx
const InputField = ({ onChange, label }) => {
  return (
    <>
      {label}
      <br />
      <input type="text" onChange={(e) => onChange(e.target.value)} />
    </>
  );
};
```

ä½†é”™è¯¯å¤„ç†å’Œæäº¤åŠŸèƒ½ä»å°†æ”¾åœ¨ `Form` ä¸­ï¼Œè€Œä¸æ˜¯è¾“å…¥ä¸­ï¼

```jsx
const Form = () => {
  const [name, setName] = useState("");
  const onSubmitClick = () => {
    if (!name) {
      // å¤„ç†ç©ºåç§°
    } else {
      // åœ¨æ­¤å¤„æäº¤æ•°æ®ï¼
    }
  };
  return (
    <>
      <InputField label="name" onChange={setName} />
      <button onClick={onSubmitClick}>Submit the form!</button>
    </>
  );
};
```

æˆ‘è¯¥å¦‚ä½•ä» `Form` ç»„ä»¶å‘Šè¯‰è¾“å…¥â€œèšç„¦è‡ªå·±â€ï¼Ÿåœ¨ React ä¸­ï¼Œæ§åˆ¶æ•°æ®å’Œè¡Œä¸ºçš„â€œæ­£å¸¸â€æ–¹å¼æ˜¯å°† props ä¼ é€’ç»™ç»„ä»¶å¹¶ç›‘å¬å›è°ƒã€‚æˆ‘å¯ä»¥å°è¯•å°† prop â€œfocusItselfâ€ ä¼ é€’ç»™ `InputField`ï¼Œå°†å…¶ä» false åˆ‡æ¢ä¸º trueï¼Œä½†è¿™åªä¼šæœ‰æ•ˆä¸€æ¬¡ã€‚

```jsx
// åˆ«è¿™æ ·ï¼åªæ˜¯ä¸ºäº†æ¼”ç¤ºå®ƒåœ¨ç†è®ºä¸Šæ˜¯å¦‚ä½•å·¥ä½œçš„
const InputField = ({ onChange, focusItself }) => {
  const inputRef = useRef(null);
  useEffect(() => {
    if (focusItself) {
      // focus è¾“å…¥ï¼ˆå¦‚æœ focusItself å±æ€§å‘ç”Ÿå˜åŒ–ï¼‰
      // å°†åªå·¥ä½œä¸€æ¬¡ï¼Œå½“ false å˜ä¸º true æ—¶
      inputRef.current.focus();
    }
  }, [focusItself]);
  // å…¶ä½™çš„åœ¨è¿™é‡Œéƒ½æ˜¯ä¸€æ ·çš„
};
```

æˆ‘å¯ä»¥å°è¯•æ·»åŠ ä¸€ä¸ª â€œonBlurâ€ å›è°ƒï¼Œåœ¨è¾“å…¥å¤±å»ç„¦ç‚¹æ—¶å°†è¯¥ `focusItself` prop é‡ç½®ä¸º falseï¼Œæˆ–è€…ç”¨éšæœºå€¼ä»£æ›¿å¸ƒå°”å€¼ï¼Œæˆ–è€…æƒ³å‡ºå…¶ä»–ä¸€äº›åˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆã€‚

å¹¸è¿çš„æ˜¯ï¼Œè¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªç»„ä»¶ï¼ˆ`Form`ï¼‰ä¸­åˆ›å»ºä¸€ä¸ª Refï¼Œå°†å…¶ä¼ é€’ç»™å¦ä¸€ä¸ªç»„ä»¶ï¼ˆ`InputField`ï¼‰ï¼Œå¹¶åœ¨é‚£é‡Œçš„åŸºç¡€ DOM å…ƒç´ ä¸Šé™„åŠ å®ƒã€‚æ¯•ç«Ÿï¼ŒRef åªæ˜¯ä¸€ä¸ªå¯å˜å¯¹è±¡ã€‚

`Form` å°†æ­£å¸¸åˆ›å»º Refï¼š

```jsx
const Form = () => {
 // åˆ›å»º Ref in Form ç»„ä»¶
 const inputRef = useRef(null);
 ...
}
```

è€Œ `InputField` ç»„ä»¶å°†æœ‰ä¸€ä¸ªæ¥å— Ref çš„ propï¼Œå¹¶æ¸²æŸ“ä¸€ä¸ªæœŸæœ› Ref çš„è¾“å…¥å­—æ®µã€‚åªæœ‰ Ref åœ¨è¿™é‡Œï¼Œè€Œä¸æ˜¯åœ¨ `InputField` ä¸­åˆ›å»ºï¼Œè€Œæ˜¯æ¥è‡ª propsï¼š

```jsx
const InputField = ({ inputRef }) => {
 // ä»£ç çš„å…¶ä½™éƒ¨åˆ†æ˜¯ç›¸åŒçš„
 // å°† prop ä¸­çš„ ref ä¼ é€’ç»™å†…éƒ¨è¾“å…¥ç»„ä»¶
     return <input ref={inputRef} ... />
}
```

Ref æ˜¯ä¸€ä¸ªå¯å˜å¯¹è±¡ï¼Œå¹¶ä¸”æ˜¯è¿™æ ·è®¾è®¡çš„ã€‚å½“æˆ‘ä»¬å°†å…¶ä¼ é€’ç»™ä¸€ä¸ªå…ƒç´ æ—¶ï¼ŒReact åœ¨åº•å±‚åªæ˜¯å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚è€Œå°†è¢«ä¿®æ”¹çš„å¯¹è±¡æ˜¯åœ¨ `Form` ç»„ä»¶ä¸­å£°æ˜çš„ã€‚å› æ­¤ï¼Œä¸€æ—¦ `InputField` è¢«æ¸²æŸ“ï¼ŒRef å¯¹è±¡å°†è¢«ä¿®æ”¹ï¼Œæˆ‘ä»¬çš„ `Form` å°†èƒ½å¤Ÿåœ¨ `inputRef.current` ä¸­è®¿é—®è¾“å…¥ DOM å…ƒç´ ï¼š

```jsx
const Form = () => {
  // åˆ›å»º Ref in Form ç»„ä»¶
  const inputRef = useRef(null);
  useEffect(() => {
    // åœ¨ InputField ä¸­å‘ˆç°çš„ â€œinputâ€ å…ƒç´ å°†åœ¨æ­¤å¤„
    console.log(inputRef.current);
  }, []);
  return (
    <>
      {/* å°† Ref ä½œä¸º prop ä¼ é€’ç»™è¾“å…¥å­—æ®µç»„ä»¶ */}
      <InputField inputRef={inputRef} />
    </>
  );
};
```

æˆ–è€…åœ¨æˆ‘ä»¬çš„æäº¤å›è°ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ `inputRef.current.focus()`ï¼Œä¸ä¹‹å‰çš„ä»£ç å®Œå…¨ç›¸åŒã€‚

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/06)
</Callout>

---

### é€šè¿‡ forwardRef ä»çˆ¶ç»„ä»¶ä¼ é€’ Ref åˆ°å­ç»„ä»¶

å¦‚æœä½ åœ¨æƒ³æˆ‘ä¸ºä»€ä¹ˆå°† prop å‘½åä¸º `inputRef`ï¼Œè€Œä¸æ˜¯ç®€å•åœ°ä½¿ç”¨ `ref`ï¼Œå…¶å®è¿™å¹¶ä¸ç®€å•ã€‚`ref` ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ propï¼›å®ƒæœ‰ç‚¹åƒä¸€ä¸ªâ€œä¿ç•™â€åç§°ã€‚åœ¨ä»¥å‰çš„æ—¥å­é‡Œï¼Œå½“æˆ‘ä»¬ä»åœ¨ç¼–å†™ç±»ç»„ä»¶æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å°† Ref ä¼ é€’ç»™ä¸€ä¸ªç±»ç»„ä»¶ï¼Œè¯¥ç»„ä»¶çš„å®ä¾‹å°†æ˜¯è¯¥ Ref çš„ `.current` å€¼ã€‚

ä½†æ˜¯å‡½æ•°ç»„ä»¶æ²¡æœ‰ç±»å®ä¾‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªä¼šåœ¨æ§åˆ¶å°ä¸­æ”¶åˆ°è­¦å‘Šï¼šâ€œå‡½æ•°ç»„ä»¶æ— æ³•è¢«èµ‹äºˆ refsã€‚å°è¯•è®¿é—®è¯¥ ref å°†å¤±è´¥ã€‚ä½ æ˜¯æƒ³ä½¿ç”¨ `React.forwardRef()` å—ï¼Ÿâ€

```jsx
const Form = () => {
  const inputRef = useRef(null);
  //å¦‚æœæˆ‘ä»¬åªè¿™æ ·åšï¼Œæˆ‘ä»¬å°†åœ¨ Console ä¸­æ”¶åˆ°è­¦å‘Š
  return <InputField ref={inputRef} />;
};
```

ä¸ºäº†è®©å®ƒå·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦å‘ React å‘å‡ºä¿¡å·ï¼Œè¡¨æ˜è¿™ä¸ª ref å®é™…ä¸Šæ˜¯æœ‰æ„çš„ï¼Œå¹¶ä¸”æˆ‘ä»¬æƒ³å¯¹å…¶è¿›è¡Œæ“ä½œã€‚æˆ‘ä»¬å¯ä»¥å€ŸåŠ© `forwardRef` å‡½æ•°æ¥å®ç°ï¼šå®ƒæ¥å—æˆ‘ä»¬çš„ç»„ä»¶ï¼Œå¹¶å°†æ¥è‡ª `ref` å±æ€§çš„ Ref æ³¨å…¥ä¸ºç»„ä»¶å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚å°±åœ¨ props ä¹‹åã€‚

```jsx
// é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨é‚£é‡Œåªæœ‰ props
// ä½†æ˜¯æˆ‘ä»¬ç”¨ forwardRef åŒ…è£…äº†ç»„ä»¶çš„å‡½æ•°
// å®ƒæ³¨å…¥ç¬¬äºŒä¸ªå‚æ•° - ref
//å¦‚æœå®ƒç”±å…¶ä½¿ç”¨è€…ä¼ é€’ç»™æ­¤ç»„ä»¶
const InputField = forwardRef((props, ref) => {
  // ä»£ç çš„å…¶ä½™éƒ¨åˆ†æ˜¯ç›¸åŒçš„
  return <input ref={ref} />;
});
```

æˆ‘ä»¬ç”šè‡³å¯ä»¥å°†ä¸Šé¢çš„ä»£ç åˆ†æˆä¸¤ä¸ªå˜é‡ï¼Œä»¥æé«˜å¯è¯»æ€§ï¼š

```jsx
const InputFieldWithRef = (props, ref) => {
  // å…¶ä½™çš„éƒ½æ˜¯ä¸€æ ·çš„
};
// æ­¤ API å°†ç”±è¡¨å•
export const InputField = forwardRef(InputFieldWithRef);
```

ç°åœ¨ï¼Œ`Form` å¯ä»¥åƒå¯¹å¾…å¸¸è§„ DOM å…ƒç´ ä¸€æ ·å°† Ref ä¼ é€’ç»™ `InputField` ç»„ä»¶ï¼š

```jsx
return <InputField ref={inputRef} />;
```

æ˜¯å¦åº”è¯¥ä½¿ç”¨ `forwardRef` æˆ–ä»…ä»…å°† Ref ä½œä¸º prop ä¼ é€’ï¼Œè¿™åªæ˜¯ä¸ªäººå–œå¥½çš„é—®é¢˜ï¼šæœ€ç»ˆç»“æœæ˜¯ç›¸åŒçš„ã€‚

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/07)
</Callout>

---

### ä½¿ç”¨ useImperativeHandle å®ç°å‘½ä»¤å¼ API

å¥½å§ï¼Œä» `Form` ç»„ä»¶èšç„¦è¾“å…¥çš„åŠŸèƒ½å·²ç»è§£å†³äº†ï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰å®Œæˆæˆ‘ä»¬çš„é…·è¡¨å•ã€‚è®°å¾—å—ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å‘ç”Ÿé”™è¯¯æ—¶é™¤äº†èšç„¦å¤–è¿˜è¦æ™ƒåŠ¨è¾“å…¥ï¼Ÿåœ¨åŸç”Ÿ JavaScript API ä¸­æ²¡æœ‰è¿™æ ·çš„ `element.shake()`ï¼Œå› æ­¤è®¿é—® DOM å…ƒç´ åœ¨è¿™é‡Œæ— æµäºäº‹ã€‚

ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°å°†å…¶å®ç°ä¸º CSS åŠ¨ç”»ï¼š

```jsx
const InputField = () => {
  //å­˜å‚¨æ˜¯å¦éœ€è¦æ‘‡æ™ƒçš„çŠ¶æ€
  const [shouldShake, setShouldShake] = useState(false);
  // åªéœ€åœ¨éœ€è¦æ‘‡åŠ¨æ—¶æ·»åŠ ç±»å - css ä¼šå¤„ç†å®ƒ
  const className = shouldShake ? "shake-animation" : "";
  // åŠ¨ç”»å®Œæˆå - è½¬æ¢çŠ¶æ€å›åˆ° falseï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦é‡æ–°å¼€å§‹
  return (
    <input className={className} onAnimationEnd={() => setShouldShake(false)} />
  );
};
```

ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•è§¦å‘å®ƒï¼Ÿå†æ¬¡ï¼Œå’Œä¹‹å‰èšç„¦çš„æƒ…å†µä¸€æ ·ï¼Œæˆ‘å¯ä»¥æƒ³å‡ºä¸€äº›ä½¿ç”¨ props çš„åˆ›é€ æ€§è§£å†³æ–¹æ¡ˆï¼Œä½†è¿™å°†çœ‹èµ·æ¥å¥‡æ€ªï¼Œå¹¶æ˜¾è‘—ä½¿ `Form` å¤æ‚åŒ–ã€‚å°¤å…¶æ˜¯è€ƒè™‘åˆ°æˆ‘ä»¬é€šè¿‡ ref å¤„ç†èšç„¦ï¼Œå› æ­¤æˆ‘ä»¬å°†ä¸ºåŒä¸€ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ¡ˆã€‚å¦‚æœæˆ‘å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›åƒ `InputField.shake()` å’Œ `InputField.focus()` çš„äº‹æƒ…å°±å¥½äº†ï¼

è¯´åˆ°èšç„¦ï¼Œä¸ºä»€ä¹ˆæˆ‘çš„ `Form` ç»„ä»¶ä»ç„¶éœ€è¦å¤„ç†åŸç”Ÿ DOM API æ¥è§¦å‘å®ƒï¼Ÿéš¾é“ä¸æ˜¯ `InputField` çš„è´£ä»»å’Œå…¨éƒ¨æ„ä¹‰åœ¨äºæŠ½è±¡æ‰è¿™æ ·çš„å¤æ‚æ€§å—ï¼Ÿä¸ºä»€ä¹ˆè¡¨å•ç”šè‡³è¦è®¿é—®åŸºç¡€ DOM å…ƒç´ â€”â€”è¿™åŸºæœ¬ä¸Šæ˜¯åœ¨æ³„éœ²å†…éƒ¨å®ç°ç»†èŠ‚ã€‚`Form` ç»„ä»¶ä¸åº”è¯¥å…³å¿ƒæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å“ªä¸ª DOM å…ƒç´ ï¼Œæˆ–è€…æˆ‘ä»¬æ˜¯å¦åœ¨ä½¿ç”¨ DOM å…ƒç´ æˆ–å…¶ä»–ä¸œè¥¿ã€‚å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œä½ æ‡‚çš„ã€‚

çœ‹èµ·æ¥æ˜¯æ—¶å€™ä¸ºæˆ‘ä»¬çš„ `InputField` ç»„ä»¶å®ç°ä¸€ä¸ªåˆé€‚çš„å‘½ä»¤å¼ API äº†ã€‚React æ˜¯å£°æ˜å¼çš„ï¼Œå¹¶æœŸæœ›æˆ‘ä»¬ä»¥æ­¤æ–¹å¼ç¼–å†™ä»£ç ã€‚ä½†æœ‰æ—¶æˆ‘ä»¬ç¡®å®éœ€è¦ä¸€ç§æ–¹æ³•æ¥ä»¥å‘½ä»¤å¼çš„æ–¹å¼è§¦å‘æŸäº›ä¸œè¥¿ã€‚å¹¸è¿çš„æ˜¯ï¼ŒReact ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªé€ƒç”Ÿèˆ±ï¼š`useImperativeHandle` é’©å­ã€‚

è¿™ä¸ªé’©å­ç¨å¾®éš¾ä»¥ç†è§£ã€‚æˆ‘ä¸å¾—ä¸é˜…è¯»æ–‡æ¡£ä¸¤æ¬¡ï¼Œå°è¯•å‡ æ¬¡ï¼Œå¹¶æŸ¥çœ‹å®é™… React ä»£ç ä¸­çš„å®ç°ï¼Œæ‰èƒ½çœŸæ­£ç†è§£å®ƒçš„ä½œç”¨ã€‚ä½†æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦ä¸¤ä¸ªä¸œè¥¿ï¼šå†³å®šæˆ‘ä»¬çš„å‘½ä»¤å¼ API çœ‹èµ·æ¥åƒä»€ä¹ˆï¼Œä»¥åŠä¸€ä¸ª Ref ä»¥å°†å…¶é™„åŠ åˆ°ã€‚å¯¹äºæˆ‘ä»¬çš„è¾“å…¥ï¼Œè¿™å¾ˆç®€å•ï¼šæˆ‘ä»¬éœ€è¦ `.focus()` å’Œ `.shake()` å‡½æ•°ä½œä¸º APIï¼Œè€Œæˆ‘ä»¬å·²ç»äº†è§£äº† refsã€‚

```jsx
// è¿™å°±æ˜¯æˆ‘ä»¬çš„ API å¯èƒ½æ˜¯ä»€ä¹ˆæ ·å­çš„
const InputFieldAPI = {
  focus: () => {
    // æ–½å±•è¿™é‡Œçš„è·å–ç„¦ç‚¹é­”æ³•
  },
  shake: () => {
    //è§¦å‘æ‘‡æ™ƒ
  },
};
```

`useImperativeHandle` é’©å­ç®€å•åœ°å°†è¯¥å¯¹è±¡é™„åŠ åˆ° Ref å¯¹è±¡çš„ â€œcurrentâ€ å±æ€§ï¼Œè¿™å°±æ˜¯å®ƒçš„å·¥ä½œåŸç†ï¼š

```jsx
const InputField = () => {
  useImperativeHandle(
    someRef,
    () => ({
      focus: () => {},
      shake: () => {},
    }),
    [],
  );
};
```

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬çš„ Refï¼Œå®ƒå¯ä»¥æ˜¯åœ¨ç»„ä»¶å†…éƒ¨åˆ›å»ºçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä» props ä¼ é€’çš„ï¼Œæˆ–è€…é€šè¿‡ `forwardRef` ä¼ é€’çš„ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿”å›å¯¹è±¡çš„å‡½æ•°â€”â€”è¿™ä¸ªå¯¹è±¡å°†ä½œä¸º `inputRef.current` å¯ç”¨ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¾èµ–æ•°ç»„ï¼Œä¸å…¶ä»–ä»»ä½• React é’©å­ç›¸åŒã€‚

å¯¹äºæˆ‘ä»¬çš„ç»„ä»¶ï¼Œè®©æˆ‘ä»¬æ˜¾å¼ä¼ é€’ Ref ä½œä¸º `apiRef` propã€‚
æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å®ç°å®é™…çš„ APIã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¦ä¸€ä¸ª Refâ€”â€”è¿™æ¬¡æ˜¯åœ¨ `InputField` å†…éƒ¨ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å°†å…¶é™„åŠ åˆ°è¾“å…¥ DOM å…ƒç´ å¹¶åƒå¾€å¸¸ä¸€æ ·è§¦å‘èšç„¦ï¼š

```jsx
// ä¼ é€’æˆ‘ä»¬å°†ç”¨ä½œå‘½ä»¤å¼ API çš„ Ref ä½œä¸º prop
const InputField = ({ apiRef }) => {
  // åˆ›å»ºå¦ä¸€ä¸ª Ref - internal to Input ç»„ä»¶
  const inputRef = useRef(null);
  // å°†æˆ‘ä»¬çš„ API â€œmergeâ€ åˆ° apiRef ä¸­
  //è¿”å›çš„å¯¹è±¡å°†å¯ç”¨ä½œ apiRef.current
  useImperativeHandle(
    apiRef,
    () => ({
      focus: () => {
        // åªéœ€è§¦å‘å¯¹é™„åŠ åˆ° DOM å¯¹è±¡çš„å†…éƒ¨ Ref çš„å…³æ³¨
        inputRef.current.focus();
      },
      shake: () => {},
    }),
    [],
  );
  return <input ref={inputRef} />;
};
```

è€Œå¯¹äºâ€œæ™ƒåŠ¨â€ï¼Œæˆ‘ä»¬åªéœ€è§¦å‘çŠ¶æ€æ›´æ–°ï¼š

```jsx
// ä¼ é€’æˆ‘ä»¬å°†ç”¨ä½œå‘½ä»¤å¼ API çš„ Ref ä½œä¸º prop
const InputField = ({ apiRef }) => {
  // è¿˜è®°å¾—æˆ‘ä»¬çš„çŠ¶æ€å—ï¼Ÿ
  const [shouldShake, setShouldShake] = useState(false);
  useImperativeHandle(
    apiRef,
    () => ({
      focus: () => {},
      shake: () => {
        // åœ¨æ­¤å¤„è§¦å‘çŠ¶æ€æ›´æ–°
        setShouldShake(true);
      },
    }),
    [],
  );
  return...
};
```

ç§ï¼æˆ‘ä»¬çš„ `Form` å¯ä»¥åˆ›å»ºä¸€ä¸ª refï¼Œå°†å…¶ä¼ é€’ç»™ `InputField`ï¼Œå¹¶èƒ½å¤Ÿç®€å•åœ°è°ƒç”¨ `inputRef.current.focus()` å’Œ `inputRef.current.shake()`ï¼Œè€Œä¸å¿…æ‹…å¿ƒå®ƒä»¬çš„å†…éƒ¨å®ç°ï¼

```jsx
const Form = () => {
  const inputRef = useRef(null);
  const [name, setName] = useState("");
  const onSubmitClick = () => {
    if (!name) {
      // å¦‚æœåç§°ä¸ºç©ºï¼Œåˆ™èšç„¦è¾“å…¥
      inputRef.current.focus();
      //ç„¶åç”©æ‰å®ƒï¼
      inputRef.current.shake();
    } else {
      // åœ¨æ­¤å¤„æäº¤æ•°æ®ï¼
    }
  };
  return (
    <>
      <InputField label="name" onChange={setName} apiRef={inputRef} />
      <button onClick={onSubmitClick}>Submit the form!</button>
    </>
  );
};
```

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/08)
</Callout>

---

### å‘½ä»¤å¼ API æ— éœ€ useImperativeHandle

å¦‚æœ `useImperativeHandle` é’©å­ä»ç„¶è®©ä½ æ„Ÿåˆ°å›°æƒ‘â€”â€”åˆ«æ‹…å¿ƒï¼Œæˆ‘ä¹Ÿæ˜¯ï¼ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦ä½¿ç”¨å®ƒæ¥å®ç°æˆ‘ä»¬åˆšåˆšå®ç°çš„åŠŸèƒ½ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œref åªæ˜¯ä¸€ä¸ªå¯å˜å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»ä½•å†…å®¹åˆ†é…ç»™å®ƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯å°†æˆ‘ä»¬çš„ API å¯¹è±¡åˆ†é…ç»™æ‰€éœ€ Ref çš„ `ref.current`ï¼Œç±»ä¼¼è¿™æ ·ï¼š

```jsx
const InputField = ({ apiRef }) => {
  useEffect(() => {
    apiRef.current = {
      focus: () => {},
      shake: () => {},
    };
  }, [apiRef]);
};
```

è¿™å‡ ä¹æ­£æ˜¯ `useImperativeHandle` åœ¨åº•å±‚æ‰€åšçš„äº‹æƒ…ã€‚è€Œä¸”å®ƒçš„å·¥ä½œæ–¹å¼ä¸ä¹‹å‰å®Œå…¨ç›¸åŒã€‚

<Callout icon="ğŸ”">
  [äº’åŠ¨ç¤ºä¾‹å’Œå®Œæ•´ä»£ç ](https://advanced-react.com/examples/09/09)
</Callout>

è¿™æ˜¯ä¸€ä¸ªç›¸å½“é…·çš„æŠ€å·§ï¼Œä¸æ˜¯å—ï¼Ÿè¯·è®°ä½ï¼šä»¥å‘½ä»¤å¼æ–¹å¼è§¦å‘æŸäº›æ“ä½œæ›´å¤šçš„æ˜¯ React ä¸­çš„ä¸€ä¸ªé€ƒç”Ÿèˆ±ã€‚åœ¨ 99% çš„æƒ…å†µä¸‹ï¼Œæ­£å¸¸çš„ props/callback æ•°æ®æµå·²ç»è¶³å¤Ÿã€‚

---

### å…³é”®è¦ç‚¹

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨ Refs å­˜å‚¨å‡½æ•°è€Œä¸æ˜¯å€¼ï¼Œä»¥åŠè¿™ä¼šå¸¦æ¥ä»€ä¹ˆåæœã€‚åœ¨æ­¤æœŸé—´ï¼Œæœ‰å‡ ç‚¹è¦è®°ä½ï¼š

- Ref åªæ˜¯ä¸€ä¸ªå¯å˜å¯¹è±¡ï¼Œå¯ä»¥å­˜å‚¨ä»»ä½•å€¼ã€‚è¯¥å€¼å°†åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´ä¿æŒä¸€è‡´ã€‚
- Ref çš„æ›´æ–°ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼Œå¹¶ä¸”æ˜¯åŒæ­¥çš„ã€‚
- æˆ‘ä»¬å¯ä»¥é€šè¿‡ `ref` å±æ€§å°† Ref åˆ†é…ç»™ DOM å…ƒç´ ã€‚
- åœ¨è¯¥å…ƒç´ æ¸²æŸ“åï¼Œæˆ‘ä»¬å°†åœ¨ `ref.current` å±æ€§ä¸­çœ‹åˆ°è¯¥å…ƒç´ ã€‚
- æˆ‘ä»¬å¯ä»¥å°† Refs ä½œä¸ºå¸¸è§„ props ä¼ é€’ç»™ä»»ä½•ç»„ä»¶ã€‚
- å¦‚æœæˆ‘ä»¬æƒ³å°†å…¶ä½œä¸ºå®é™…çš„ ref prop ä¼ é€’ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥ç»„ä»¶åŒ…è£…åœ¨ `forwardRef` ä¸­ã€‚å¦åˆ™ï¼Œå®ƒåœ¨å‡½æ•°ç»„ä»¶ä¸­å°†ä¸èµ·ä½œç”¨ã€‚è¯¥ç»„ä»¶çš„ç¬¬äºŒä¸ªå‚æ•°å°†æ˜¯ ref æœ¬èº«ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ä¼ é€’ç»™æ‰€éœ€çš„ DOM å…ƒç´ ã€‚

  ```jsx
  // ç¬¬äºŒä¸ªå‚æ•°ï¼Œç´§æ¥ç€ propsï¼Œæ˜¯ç”±â€œforwardRefâ€æ³¨å…¥çš„ ref
  const InputField = forwardRef((props, ref) => {
    return <input ref={ref} />;
  });
  ```

- æˆ‘ä»¬å¯ä»¥éšè—ç»„ä»¶çš„å®ç°ç»†èŠ‚ï¼Œå¹¶é€šè¿‡ `useImperativeHandle` é’©å­å…¬å¼€å…¶å…¬å…± APIã€‚æˆ‘ä»¬éœ€è¦å°† Ref ä¼ é€’ç»™è¯¥ç»„ä»¶ï¼Œè¿™å°†è¢«åŒ…å« API å±æ€§æ‰€ä¿®æ”¹ï¼š

  ```jsx
  const InputField = () => {
    useImperativeHandle(
      ousideRef,
      () => ({
        focus: () => {},
        shake: () => {},
      }),
      [],
    );
  };
  ```

- æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `useEffect` é’©å­ä¸­æ‰‹åŠ¨ä¿®æ”¹è¯¥ Refã€‚

  ```jsx
  const InputField = ({ apiRef }) => {
    useEffect(() => {
      ousideRef.current = {
        focus: () => {},
        shake: () => {},
      };
    }, [ousideRef]);
  };
  ```
